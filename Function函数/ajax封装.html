<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AJAX封装</title>
</head>
<body>
  <script>
      // 2022年3月5日 实现AJAX的封装

      // 这种样子的封装有什么问题？
      // 这个是命名空间的写法，其实也没啥大问题在单一的中小型网站上使用
      /**
       *缺点：网站规模变大，项目多的时候，管理多个命名空间就容易发生冲突，
       模块被覆盖掉。 
       **/
      ;(function(){
        var $ = {
        ajax: function() {
          console.log(`ajax1：`,);
        },
        post: function() {
          console.log('post');
        },
        get: function() {
          console.log('get');
        }
      }
      $.ajax()
      }())
      
      ;(function(){
        console.warn('=======使用$=Object 实现$.ajax=======')
        function $() {
        return {
          ajax: function() {
          console.log(`ajax2：`,);
        },
        post: function() {
          console.log('post');
        },
        get: function() {
          console.log('get');
        }
        }
      }
      // 调用方式多了个括号；如何去掉括号？变成$.ajax()
      $().ajax()
      }())
     
      // 立即执行函数返回对象给变量
      ;(function(){
        
      }())

      var $ = function () {
        return {
          ajax: function() {
          console.log(`ajax3：`,);
        },
        post: function() {
          console.log('post');
        },
        get: function() {
          console.log('get');
        }
        }
      }()

      $.ajax()


      var $ =(function(){
        return {
          ajax: function() {
            console.log(`ajax4：`,);
          },
        }
      })()
      $.ajax()

      var $ =(function(){
        var xhr = window.XMLHttpRequest? new XMLHttpRequest: new ActiveXObject("Microsoft.XMLHTTP");
        if(!xhr) {
          throw new Error("你的浏览器不支持异步发起HTTP请求")
        }

        function _doAjax(options) {
          let opt = options || {},
            type = (opt.type || 'GET').toLowerCase(),
            async = opt.async+'' === false ? false : true,
            dataType = opt.dataType || 'JSON',
            jsonp = opt.jsonp || 'cb',
            jsonpCallback = opt.jsonpCallback || 'jQuery' + randomNum() + '_' + new Date().getTime(),
            url = opt.url || '',
            data  = opt.data || null,
            timeout = opt.timeout || 5000,
            error = opt.error || function () {},
            success = opt.success || function () {},
            complete = opt.complete || function () {},
            t = null;

            if(!url) {
              throw new Error('请输入URL')
            }

            xhr.open(type, url, async)
            type === 'POST'&& xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded')
            xhr.send(type === 'GET' ? null: formatDatas(data))

            t = setTimeout(function() {
              xhr.abort()
              clearTimeout(t)
              t = null;
              xhr = null;
              throw new Error('请求超时，请求地址：'+ url)
            }, timeout)
            
            xhr.onreadystatechange = function() {
              console.log('readyState', xhr.readyState);
              
              if(xhr.readyState === 4) {
                if(xhr.status === 200 ) {
                  switch(dataType.toUpperCase()) {
                    case "JSON":
                      success(JSON.parse(xhr.responseText))
                      break;
                    case 'TEXT':
                      success(xhr.responseText)
                      break;
                    case "XML":
                      success(xhr.responseXML);
                      break;
                    default:
                      success(JSON.parse(xhr.responseText))
                  }
                } else {
                  error()
                }
                complete();
                clearTimeout(t)
                t = null;
                xhr = null
              }
            }

        }

        function formatDatas(obj) {
          let res = ''
          for(let key in obj) {
            res += `${key}=${obj[key]}&`
          }
          return res.replace(/&$/, '')
        }

        function randomNum() {
          let num = ''
          for(let i = 0; i < 10; i++) {
            num +=Math.floor(Math.random() * 10)
          }
          return num
        }

        return {
          ajax: function(options) {
            console.log(`ajax5：`,);
            _doAjax(options)
          },
          post: function(options) {
            console.log('post');
            
          },
          get: function(options) {
            console.log('get');
          }
        }
      })()

      $.ajax({
        type: 'POST',
        url: 'http://localhost:8888/api/getList',
        success: function(data) {
          console.log(`data：`,data);
        },
        error: function(error) {
          console.log(`error：`,error);
        },
        complete: function() {
          console.log(`complete：`,);
          
        }
      })

      $.ajax({
        type: 'GET',
        url: 'http://localhost:8888/api/?name=菜鸟教程&url=www.runoob.com',
        success: function(data) {
          console.log(`data：`,data);
        },
        error: function(error) {
          console.log(`error：`,error);
        },
        complete: function() {
          console.log(`complete：`,);
          
        }
      })



  </script>
</body>
</html>